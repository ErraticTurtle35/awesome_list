import 'dart:convert';
import 'package:awersome_list/src/article.dart';
import 'package:test_api/test_api.dart';
import 'package:http/http.dart' as http;

void main() {
  test('parses topstories.json', () {
    const jsonString =
        "[19273955,19277411,19276113,19276751,19274941,19273403,19270646,19277263,19271487,19274175,19275755,19270960,19276542,19272874,19275738,19271162,19274406,19271393,19276977,19274094,19275260,19271816,19277030,19273312,19270886,19276993,19273409,19261310,19262904,19269089,19271569,19274135,19276342,19270862,19270786,19274784,19271747,19274053,19274738,19271135,19266033,19264048,19277004,19270789,19274997,19275486,19271132,19274668,19269321,19270217,19274661,19271299,19270199,19268734,19275772,19273515,19274580,19269938,19274204,19276476,19275634,19269517,19265795,19271851,19260306,19266823,19268919,19271989,19270779,19270527,19254829,19263814,19275315,19271766,19262249,19268136,19275202,19271468,19275762,19268977,19271064,19275990,19263649,19265061,19274610,19274778,19268989,19261354,19273554,19263917,19263057,19264154,19260534,19275227,19271671,19272842,19262477,19267506,19269090,19262657,19274962,19274179,19275802,19274448,19261324,19275394,19274512,19266517,19266219,19271556,19264483,19264764,19274093,19267155,19257888,19265811,19270430,19265609,19270882,19266867,19254008,19257358,19268261,19268290,19275848,19265377,19254828,19267034,19274692,19275985,19264127,19262050,19269515,19264205,19256746,19275627,19263962,19269333,19262263,19267148,19275520,19260368,19258461,19268902,19258489,19262998,19265788,19270689,19253991,19262386,19273187,19260493,19262804,19259081,19263086,19255102,19265020,19256845,19270667,19260903,19271069,19265750,19262693,19276228,19274969,19261018,19254640,19265219,19265172,19268685,19258717,19270815,19265404,19257857,19274679,19273723,19261376,19268128,19262529,19256345,19274533,19255603,19254818,19262732,19269151,19258429,19262349,19257267,19274265,19263332,19258987,19259364,19274083,19257350,19263393,19256271,19254318,19256514,19270823,19255215,19259099,19258241,19260840,19257727,19255802,19272220,19255475,19261080,19262590,19263341,19268431,19266595,19268590,19274417,19257762,19260687,19255227,19268808,19265396,19255302,19256059,19256096,19256431,19257434,19263385,19257241,19255286,19263590,19271173,19270494,19262154,19253787,19256435,19259911,19271951,19264918,19258579,19266904,19258826,19258949,19264243,19262243,19256313,19265960,19256654,19268320,19272996,19260580,19270445,19257675,19263489,19255131,19254619,19268089,19256553,19263543,19258472,19267468,19262489,19253872,19255206,19258551,19267448,19256772,19264406,19270767,19258968,19267163,19270685,19258059,19268097,19266645,19268069,19269695,19263729,19268491,19267176,19268795,19258862,19264093,19265440,19255690,19261888,19257987,19265525,19265691,19267418,19264149,19266614,19260808,19264152,19254409,19254110,19271164,19264208,19264116,19257086,19267435,19256523,19256336,19268225,19260117,19254578,19253811,19256970,19261019,19261590,19264003,19263998,19266144,19261516,19263874,19268883,19263294,19267607,19257103,19271535,19257677,19258281,19256753,19263618,19257409,19254751,19264065,19271910,19260167,19254931,19268005,19267993,19254508,19265406,19257062,19265884,19256537,19260611,19263995,19258616,19261017,19266891,19258061,19263275,19266599,19259363,19257063,19266073,19260995,19265866,19254652,19257797,19259451,19260810,19264296,19258442,19263916,19261594,19263561,19259982,19254537,19259674,19261257,19261226,19256477,19261143,19255760,19253804,19257442,19265513,19257400,19253978,19257221,19257009,19259825,19261880,19258370,19256805,19260896,19260841,19267886,19260449,19255527,19260222,19264106,19260132,19254976,19263852,19259921,19259023,19254809,19258371,19258285,19258272,19258231,19257218,19256645,19256600,19255939,19255921,19254841,19254201,19264648,19258056,19258447,19265975,19259106,19253829,19264876,19254903,19263686,19275305,19270352,19255096,19263806,19263357,19255176]";

    expect(parseTopStories(jsonString).first, 19273955);
  });

  test('parses item.json', () {
    const jsonString = """
    {"by":"dhouston","descendants":71,"id":8863,"kids":[9224,8917,8952,8884,8887,8869,8940,8908,8958,9005,8873,9671,9067,9055,8865,8881,8872,8955,10403,8903,8928,9125,8998,8901,8902,8907,8894,8870,8878,8980,8934,8943,8876],"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}
    """;

    expect(parseArticle(jsonString).by, "dhouston");
  });

  test('parses item.json by the network', () async {
    final urlPrefix = 'https://hacker-news.firebaseio.com/v0/beststories.json';
    final bestStoriesResponse = await http.get(urlPrefix);
    if (bestStoriesResponse.statusCode == 200) {
      final bestStoriesIds = json.decode(bestStoriesResponse.body);
      if (bestStoriesIds.isNotEmpty) {
        final storyUrl =
            'https://hacker-news.firebaseio.com/v0/item/${bestStoriesIds.first}.json';
        final storyResponse = await http.get(storyUrl);
        if (storyResponse.statusCode == 200) {
          expect(parseArticle(storyResponse.body).by, "tingletech");
        }
      }
    }
    return null;
  });
}
